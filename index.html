<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>---Streamer Simulator---</title>
    
    <!-- Core Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- MathJax -->
    <script> window.MathJax = { tex: { inlineMath: [['$', '$']] }, svg: { fontCache: 'global' } }; </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@600;800&display=swap');
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Rajdhani', sans-serif; user-select: none; touch-action: none; }
        .pixel-font { font-family: 'Press Start 2P', cursive; }

        /* Touch Controls */
        .touch-layer { position: absolute; inset: 0; z-index: 10; display: flex; }
        .touch-zone { flex: 1; }
        .joystick-base { position: absolute; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; pointer-events: none; display: none; z-index: 15; }
        .joystick-stick { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; transform: translate(-50%, -50%); }

        /* Chat Scroll */
        .chat-container { mask-image: linear-gradient(to bottom, transparent, black 10%); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, memo, useCallback } = React;

        // --- CHAT DATA ---
         const TENGLISH_CHATS = [
            {u: "fanboy123", t: "Anna nuvvu thopu, dammu unte aapu!"},
            {u: "student_no1", t: "Super logic anna! Mind blowing!"},
            {u: "backbencher", t: "Rey evadra nuvvu? Anni correct pedthunnav?"},
            {u: "ecet_aspirant", t: "TS ECET 2026 Rank 1 manade!"},
            {u: "hater_99", t: "Laggg... net slow ah bro?"},
            {u: "balayya_fan", t: "JAI BALAYYA! JAI JAI BALAYYA!"},
            {u: "funny_guy", t: "Dabidi Dibide!"},
            {u: "unknown", t: "Bro, next CM nuvve!"},
            {u: "troller", t: "Enti bro idi? 2nd class question la undi."},
            { u: "backlog_babu", t: "Syllabus samudhram, time emo spoon.. em cheyam antav? ðŸ˜­" },
            { u: "sbtet_hater", t: "Paper evadu tayaru chesina.. manam matram 'Dabidi Dibide'!" },
            { u: "rank_hunter", t: "1st Rank kottakapothe intlo belt treatment fix!" },
            { u: "maths_hater", t: "Integration chusthe BP, Differentiation chusthe Sugar ostundi!" },
            { u: "chill_bro", t: "Rey, inka start cheyaleda? Next year rasko inka!" },
            { u: "copy_cat", t: "Slip lu pettadam kala, dorakadam vilayame!" },
            { u: "pubg_lover", t: "ECET kanna Pochinki lo digadam easy ra mowa." },
            { u: "topper_hater", t: "Rey topper ga, doubt adagaku.. maaku heart attack ostundi." },
            { u: "last_night_study", t: "Nidra pothe rank radhu, chadivithe burra panicheyadu!" },
            { u: "balayya_bhakthudu", t: "Paper tough ga isthe, result rough ga untadi! Jai Balayya!" },
            { u: "confused_atma", t: "E branch tiskuna papam ki.. narakam chupistunaru kada ra!" },
            { u: "future_failure", t: "Pass aithe party, Fail aithe tea party (stall pedatha)!" },
            { u: "single_pasanga", t: "Love failure kante, Rank failure chala badha ra chari." },
            { u: "cse_hacker", t: "Coding easy, kani Chemistry ne mystery!" },
            { u: "btech_dreamer", t: "OU/JNTU seat rakapothe, life lo 'Error 404' eh!" },
            { u: "mid_exam_king", t: "Mids lo thopu, Finals lo papu.. ade na jeevitham." },
            { u: "roast_master", t: "Nee preparation chustunte, rank kaadu, 'Thank You' card ochela undi." },
            { u: "jits_boy", t: "Mahesh anna, nuvvu cheppindi rakapothe nee intiki osta!" },
            { u: "backbench_don", t: "Mundhu bench vallu answers rayali, venaka bench vallu history create cheyali!" },
            { u: "exam_warrior", t: "Yuddham shuru.. Hall Ticket eh na weapon!" },
            { u: "lazy_lad", t: "Shortcuts cheppu anna.. Long answers chadive opika ledu." },
            { u: "physics_psycho", t: "Newton gadi thalakai meeda apple kaadu, watermelon padalsindi." },
            { u: "biryani_addict", t: "Exam aipogane Bawarchi lo kaluddam.. appati varaku disturb cheyakandi." },
            { u: "sarkar_fan", t: "Nenu chadivithe history.. chadavakapothe mystery!" },
            { u: "diploma_devudas", t: "3 years Diploma biscuit, ippudu ECET chocolate kavali!" },
            { u: "unknown_legend", t: "Rey evarra meerantha? Chadavandi ra ayya firstu!" },
            { u: "cheat_code_user", t: "A, B, C, D... edoka jai ani petteyadam eh!" },
            { u: "over_confident", t: "Paper chala easy.. (bayataki vachi edustadu)." },
            { u: "night_owl", t: "Surya namaskaram kante, Chandra namaskaram ekkuva chestunna (Night Study)!" },
            { u: "stress_master", t: "BP tablet veskoni class vintunna.. thaggede le!" },
            { u: "coder_babu", t: "Logic chimpesav anna!" },
            { u: "last_bencher", t: "Eesari pass guarantee ra chari!" },
            { u: "ecet_ranker", t: "Rank 1 loading..." },
            { u: "pushpa_raj", t: "Thaggedhe Le! ðŸ”¥" },
            { u: "chitti_robot", t: "Speed 1 terabyte, memory 1 zettabyte!" },
            { u: "backlog_king", t: "M1 kuda easy aipoindi ro!" },
            { u: "vizag_kurradu", t: "Explanation adirindi, whistle esko!" },
            { u: "debug_master", t: "Bug leni code, nuvvu cheppe mode!" },
            { u: "unknown_hacker", t: "Site design vere level asalu!" },
            { u: "diploma_don", t: "SBTET ki cheppu manam vachamani!" },
            { u: "rowdy_boy", t: "Anna osthe mass jathare!" },
            { u: "maths_magician", t: "Integration ippudu water la undi!" },
            { u: "cinema_pichodu", t: "Climax twist range lo undi class!" },
            { u: "future_engineer", t: "Placement fix aipoindi boys!" },
            { u: "warangal_warrior", t: "Mana domination eh inka!" },
            { u: "python_pro", t: "Indentation error leni life needi!" },
            { u: "circuit_raja", t: "Fuse lu egiripoyayi concept ki ðŸ¤¯" },
            { u: "nidra_moham", t: "Nightout ki perfect companion bro!" },
            { u: "java_jagan", t: "Object Oriented devudu saami!" },
            { u: "meme_god", t: "Content keka, cuts keka!" },
            { u: "looser_no_more", t: "Confidence perigindi anna!" },
            { u: "btech_badhithudu", t: "Diploma days gurthochayi ðŸ˜­" },
            { u: "amarendra_bahubali", t: "Mahishmathi ki raavali meeru!" },
            { u: "keyboard_warrior", t: "Typing speed kanna nee thinking speed ekkuva!" },
            { u: "biryani_lover", t: "Class vinthu biryani thinnantha kick vachindi!" },
            { u: "exam_fear", t: "Nuvvu unte fear enduku dhandaga?" },
            { u: "sarkar_fan", t: "Okka vote... ade okka like esa!" },
            { u: "c_language_lover", t: "Pointers kante sharp nee maata!" },
            { u: "jits_student", t: "Mahesh anna thopu, dammunte aapu!" },
            { u: "final_year_guy", t: "Project ki help chey anna, life istha!" },
        ];
        const LOVER_CHATS = [
            [{u: "vedanth143", t: "Babu tinna?"}, {u: "vedanth_pilla1432", t: "Ha tinna ra bujji, nuvvu?"}],
            [{u: "vedanth143", t: "Miss u bangaram"}, {u: "vedanth_pilla1432", t: "Miss u too ra kanna <3"}],
            { u: "backlog_babu", t: "Syllabus samudhram, time emo spoon.. em cheyam antav? ðŸ˜­" },
            { u: "sbtet_hater", t: "Paper evadu tayaru chesina.. manam matram 'Dabidi Dibide'!" },
            { u: "rank_hunter", t: "1st Rank kottakapothe intlo belt treatment fix!" },
            { u: "maths_hater", t: "Integration chusthe BP, Differentiation chusthe Sugar ostundi!" },
            { u: "chill_bro", t: "Rey, inka start cheyaleda? Next year rasko inka!" },
            { u: "copy_cat", t: "Slip lu pettadam kala, dorakadam vilayame!" },
            { u: "pubg_lover", t: "ECET kanna Pochinki lo digadam easy ra mowa." },
            { u: "topper_hater", t: "Rey topper ga, doubt adagaku.. maaku heart attack ostundi." },
            { u: "last_night_study", t: "Nidra pothe rank radhu, chadivithe burra panicheyadu!" },
            { u: "balayya_bhakthudu", t: "Paper tough ga isthe, result rough ga untadi! Jai Balayya!" },
            { u: "confused_atma", t: "E branch tiskuna papam ki.. narakam chupistunaru kada ra!" },
            { u: "future_failure", t: "Pass aithe party, Fail aithe tea party (stall pedatha)!" },
            { u: "single_pasanga", t: "Love failure kante, Rank failure chala badha ra chari." },
            { u: "cse_hacker", t: "Coding easy, kani Chemistry ne mystery!" },
            { u: "btech_dreamer", t: "OU/JNTU seat rakapothe, life lo 'Error 404' eh!" },
            { u: "mid_exam_king", t: "Mids lo thopu, Finals lo papu.. ade na jeevitham." },
            { u: "roast_master", t: "Nee preparation chustunte, rank kaadu, 'Thank You' card ochela undi." },
            { u: "jits_boy", t: "Mahesh anna, nuvvu cheppindi rakapothe nee intiki osta!" },
            { u: "backbench_don", t: "Mundhu bench vallu answers rayali, venaka bench vallu history create cheyali!" },
            { u: "exam_warrior", t: "Yuddham shuru.. Hall Ticket eh na weapon!" },
            { u: "lazy_lad", t: "Shortcuts cheppu anna.. Long answers chadive opika ledu." },
            { u: "physics_psycho", t: "Newton gadi thalakai meeda apple kaadu, watermelon padalsindi." },
            { u: "biryani_addict", t: "Exam aipogane Bawarchi lo kaluddam.. appati varaku disturb cheyakandi." },
            { u: "sarkar_fan", t: "Nenu chadivithe history.. chadavakapothe mystery!" },
            { u: "diploma_devudas", t: "3 years Diploma biscuit, ippudu ECET chocolate kavali!" },
            { u: "unknown_legend", t: "Rey evarra meerantha? Chadavandi ra ayya firstu!" },
            { u: "cheat_code_user", t: "A, B, C, D... edoka jai ani petteyadam eh!" },
            { u: "over_confident", t: "Paper chala easy.. (bayataki vachi edustadu)." },
            { u: "night_owl", t: "Surya namaskaram kante, Chandra namaskaram ekkuva chestunna (Night Study)!" },
            { u: "stress_master", t: "BP tablet veskoni class vintunna.. thaggede le!" }
];


        // --- MATH RENDERER ---
        const MathText = memo(({ text }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.MathJax && ref.current) {
                    ref.current.innerHTML = text;
                    window.MathJax.typesetPromise([ref.current]).catch(()=>{});
                }
            }, [text]);
            return <span ref={ref} />;
        });

        // --- THREE.JS ENGINE (MEMORY SAFE) ---
        const GameEngine = memo(({ controlsRef, onGameStateChange }) => {
            const mountRef = useRef(null);
            
            useEffect(() => {
                if (!mountRef.current) return;

                // 1. SETUP
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog = new THREE.Fog(0x87CEEB, 20, 100);
                const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 150);
                const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                mountRef.current.appendChild(renderer.domElement);

                // Lights
                const sun = new THREE.DirectionalLight(0xffffff, 1.5);
                sun.position.set(50, 100, 50);
                sun.castShadow = true;
                // Optimize shadow map size for mobile stability
                sun.shadow.mapSize.width = 1024; 
                sun.shadow.mapSize.height = 1024; 
                scene.add(sun);
                scene.add(new THREE.AmbientLight(0xffffff, 0.6));

                // Ground
                const ground = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshStandardMaterial({ color: 0x4caf50 }));
                ground.rotation.x = -Math.PI/2;
                ground.receiveShadow = true;
                scene.add(ground);

                // --- ASSETS ---
                const createBox = (w, h, d, color, x, y, z) => {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({ color }));
                    m.position.set(x,y,z); m.castShadow = true; m.receiveShadow = true;
                    return m;
                };

                // Houses
                const houses = [];
                const houseLocs = [{x: -30, z: -30}, {x: 30, z: -30}, {x: -30, z: 30}, {x: 50, z: 0}, {x: 0, z: 50}, {x: -50, z: 10}];
                houseLocs.forEach((loc, i) => {
                    const h = new THREE.Group();
                    h.position.set(loc.x, 0, loc.z);
                    h.add(createBox(8, 6, 8, Math.random() > 0.5 ? 0xeeeeee : 0xffcccc, 0, 3, 0));
                    const roof = new THREE.Mesh(new THREE.ConeGeometry(6, 4, 4), new THREE.MeshStandardMaterial({ color: 0x883333 }));
                    roof.position.y = 8; roof.rotation.y = Math.PI/4;
                    h.add(roof);
                    h.add(createBox(2, 3, 0.5, 0x442200, 0, 1.5, 4));
                    scene.add(h);
                    houses.push({ pos: new THREE.Vector3(loc.x, 0, loc.z), id: i });
                });

                // Base & Shop
                const home = new THREE.Group(); home.position.set(0,0,-10);
                home.add(createBox(10, 0.2, 10, 0x333333, 0, 0.1, 0)); 
                const desk = createBox(4, 1.5, 2, 0x111111, 0, 1, 0); desk.add(createBox(2, 1.2, 0.1, 0x00ff00, 0, 1.5, 0)); home.add(desk);
                scene.add(home);

                const shop = new THREE.Group(); shop.position.set(20, 0, 20);
                shop.add(createBox(12, 7, 12, 0xffaa00, 0, 3.5, 0)); shop.add(createBox(10, 2, 1, 0xffffff, 0, 8, 6));
                scene.add(shop);

                // Bike
                const bike = new THREE.Group(); bike.position.set(5, 0, 5);
                bike.add(createBox(1, 1, 3, 0xffff00, 0, 0.5, 0)); bike.add(createBox(2, 0.2, 0.5, 0xcccccc, 0, 1.5, 0.5));
                bike.add(createBox(0.8, 0.8, 0.2, 0x111111, 0, 0.4, 1)); bike.add(createBox(0.8, 0.8, 0.2, 0x111111, 0, 0.4, -1));
                scene.add(bike);

                // Player
                const player = new THREE.Group();
                const body = createBox(0.8, 1, 0.4, 0x3b82f6, 0, 1.5, 0);
                const head = createBox(0.6, 0.6, 0.6, 0xffccaa, 0, 2.3, 0);
                const lArm = createBox(0.3, 1, 0.3, 0xffccaa, 0.6, 1.5, 0);
                const rArm = createBox(0.3, 1, 0.3, 0xffccaa, -0.6, 1.5, 0);
                const lLeg = createBox(0.35, 1, 0.35, 0x1e3a8a, 0.2, 0.5, 0);
                const rLeg = createBox(0.35, 1, 0.35, 0x1e3a8a, -0.2, 0.5, 0);
                player.add(body); player.add(head); player.add(lArm); player.add(rArm); player.add(lLeg); player.add(rLeg);
                scene.add(player);

                // Arrow
                const arrow = new THREE.Group();
                const shaft = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 2, 8), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
                shaft.rotation.x = Math.PI / 2; 
                shaft.position.z = 1;
                const cone = new THREE.Mesh(new THREE.ConeGeometry(0.5, 1, 8), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
                cone.rotation.x = Math.PI / 2;
                cone.position.z = 2.5;
                arrow.add(shaft); arrow.add(cone); arrow.visible = false;
                scene.add(arrow);

                // --- LOOP STATE ---
                const clock = new THREE.Clock();
                let isRiding = false;
                let bikeVel = 0;
                let bikeRot = 0;
                let camAngle = { theta: Math.PI, phi: Math.PI/3 };
                let targetLoc = null;
                
                // STABILITY: Local State Tracker to prevent excessive React calls
                let lastActionText = null;
                let frameCount = 0; // Only update UI every X frames

                let animationId;

                const animate = () => {
                    animationId = requestAnimationFrame(animate);
                    const dt = Math.min(clock.getDelta(), 0.1);
                    const ctrl = controlsRef.current;
                    frameCount++;

                    // Cam
                    camAngle.theta -= ctrl.lookX * 5.0 * dt; 
                    camAngle.phi -= ctrl.lookY * 5.0 * dt;
                    camAngle.phi = Math.max(0.1, Math.min(Math.PI-0.2, camAngle.phi));
                    ctrl.lookX = 0; ctrl.lookY = 0;

                    const activeObj = isRiding ? bike : player;
                    
                    if (isRiding) {
                        if (ctrl.moveY !== 0) bikeVel += ctrl.moveY * 50 * dt;
                        else bikeVel *= 0.92; 
                        bikeVel = Math.max(-15, Math.min(50, bikeVel));

                        if (Math.abs(bikeVel) > 1) bikeRot -= ctrl.moveX * 8 * dt;
                        bike.rotation.y = bikeRot;
                        bike.translateZ(-bikeVel * dt);

                        player.position.copy(bike.position); player.position.y += 0.5; player.rotation.y = bike.rotation.y;
                        lLeg.rotation.x = -1.5; rLeg.rotation.x = -1.5; lArm.rotation.x = -0.5; rArm.rotation.x = -0.5;
                    } else {
                        const speed = 12;
                        if (Math.abs(ctrl.moveX) > 0.1 || Math.abs(ctrl.moveY) > 0.1) {
                            const sin = Math.sin(camAngle.theta); const cos = Math.cos(camAngle.theta);
                            player.position.x -= (sin * ctrl.moveY - cos * ctrl.moveX) * speed * dt;
                            player.position.z -= (cos * ctrl.moveY + sin * ctrl.moveX) * speed * dt;
                            
                            const tr = Math.atan2(-(sin * ctrl.moveY - cos * ctrl.moveX), -(cos * ctrl.moveY + sin * ctrl.moveX));
                            let rd = tr - player.rotation.y;
                            while(rd > Math.PI) rd -= Math.PI*2; while(rd < -Math.PI) rd += Math.PI*2;
                            player.rotation.y += rd * 25 * dt; 

                            lLeg.rotation.x = Math.sin(clock.getElapsedTime()*15)*0.6;
                            rLeg.rotation.x = Math.sin(clock.getElapsedTime()*15 + Math.PI)*0.6;
                        } else {
                            lLeg.rotation.x = 0; rLeg.rotation.x = 0;
                        }
                        lArm.rotation.x = 0; rArm.rotation.x = 0;
                    }

                    // Cam Follow
                    const camDist = 12; 
                    const cx = activeObj.position.x + camDist * Math.sin(camAngle.phi) * Math.sin(camAngle.theta);
                    const cz = activeObj.position.z + camDist * Math.sin(camAngle.phi) * Math.cos(camAngle.theta);
                    const cy = activeObj.position.y + camDist * Math.cos(camAngle.phi);
                    camera.position.set(cx, cy, cz);
                    camera.lookAt(activeObj.position.x, activeObj.position.y + 2, activeObj.position.z);

                    // Arrow Logic
                    if (targetLoc) {
                        arrow.visible = true;
                        arrow.position.set(activeObj.position.x, activeObj.position.y + 5, activeObj.position.z);
                        arrow.lookAt(targetLoc.x, activeObj.position.y + 5, targetLoc.z);
                    } else {
                        arrow.visible = false;
                    }

                    // --- LOGIC THROTTLING (Prevents Blank Screen) ---
                    // Only run "Heavy" logic every 10 frames
                    if (frameCount % 10 === 0) {
                        const distBike = player.position.distanceTo(bike.position);
                        const distPC = player.position.distanceTo(new THREE.Vector3(0,0,-10));
                        const distShop = player.position.distanceTo(new THREE.Vector3(20,0,20));
                        const distTarget = targetLoc ? player.position.distanceTo(targetLoc) : 999;

                        // Calculate Action Text
                        let newActionText = null;
                        if (distBike < 4 && !isRiding) newActionText = "RIDE";
                        else if (isRiding) newActionText = "EXIT";
                        else if (distPC < 5) newActionText = "STREAM";
                        else if (distShop < 10 && !targetLoc) newActionText = "TAKE JOB";
                        else if (targetLoc && distTarget < 10) newActionText = "DELIVER";

                        // ONLY update React if text changed (Critical Fix)
                        if (newActionText !== lastActionText) {
                            lastActionText = newActionText;
                            onGameStateChange({ type: 'UPDATE_ACTION', payload: newActionText });
                        }

                        // Handle Click (Consumed immediately)
                        if (ctrl.interact) {
                            ctrl.interact = false;
                            if (distBike < 4 || isRiding) {
                                isRiding = !isRiding; bikeRot = bike.rotation.y;
                                onGameStateChange({ type: 'MSG', payload: isRiding ? "RIDING BIKE" : "WALKING" });
                            }
                            else if (!isRiding && distPC < 5) onGameStateChange({ type: 'STREAM_START' });
                            else if (distShop < 10 && !targetLoc) {
                                targetLoc = houses[Math.floor(Math.random() * houses.length)].pos;
                                onGameStateChange({ type: 'JOB_START', payload: "Follow Red Arrow!" });
                            }
                            else if (targetLoc && distTarget < 10) {
                                targetLoc = null;
                                onGameStateChange({ type: 'JOB_COMPLETE', payload: 200 });
                            }
                        }
                    }

                    renderer.render(scene, camera);
                };
                animate();

                const resize = () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };
                window.addEventListener('resize', resize);
                
                // CLEANUP
                return () => { 
                    window.removeEventListener('resize', resize); 
                    cancelAnimationFrame(animationId);
                    if(mountRef.current) {
                        mountRef.current.innerHTML = "";
                        renderer.dispose();
                    }
                };
            }, []); // Empty dep array = Run once forever
            return <div ref={mountRef} className="absolute inset-0" />;
        });

        // --- APP ---
        const App = () => {
            const [started, setStarted] = useState(false);
            const [apiKey, setApiKey] = useState("");
            const [gameState, setGameState] = useState({ money: 100, subs: 0, job: false, actionText: null, msg: null, showStream: false, showTip: false });
            const [deliveryTip, setDeliveryTip] = useState(null);
            
            const controlsRef = useRef({ moveX: 0, moveY: 0, lookX: 0, lookY: 0, interact: false });
            const joyRef = useRef(null);
            
            const joyTouchRef = useRef(null);
            const lookTouchRef = useRef(null);

            // STREAM
            const [chat, setChat] = useState([]);
            const [qBuffer, setQBuffer] = useState([]);
            const [currentQ, setCurrentQ] = useState(null);
            const [explanation, setExplanation] = useState(null);
            const [loading, setLoading] = useState(false);
            const fetchLock = useRef(false);

            // Game State Handler (Stable Reference for Engine)
            const handleGameUpdate = useCallback((action) => {
                setGameState(prev => {
                    switch(action.type) {
                        case 'UPDATE_ACTION': return { ...prev, actionText: action.payload };
                        case 'MSG': return { ...prev, msg: action.payload };
                        case 'STREAM_START': return { ...prev, showStream: true };
                        case 'JOB_START': return { ...prev, job: true, msg: action.payload };
                        case 'JOB_COMPLETE': return { ...prev, job: false, money: prev.money + action.payload, msg: "DELIVERED! +â‚¹" + action.payload, showTip: true };
                        default: return prev;
                    }
                });
            }, []);

            // Keyboard
            useEffect(() => {
                const k = (e, d) => {
                    const v = d?1:0;
                    if(e.key==='w') controlsRef.current.moveY=v; if(e.key==='s') controlsRef.current.moveY=-v;
                    if(e.key==='a') controlsRef.current.moveX=-v; if(e.key==='d') controlsRef.current.moveX=v;
                    if(e.key.includes('Arrow')) {
                        if(e.key==='ArrowUp') controlsRef.current.lookY=v; if(e.key==='ArrowDown') controlsRef.current.lookY=-v;
                        if(e.key==='ArrowLeft') controlsRef.current.lookX=-v; if(e.key==='ArrowRight') controlsRef.current.lookX=v;
                    }
                    if(e.key==='e' && d) controlsRef.current.interact=true;
                    if(e.key==='f' && d) toggleFullscreen();
                };
                window.addEventListener('keydown',e=>k(e,true)); window.addEventListener('keyup',e=>k(e,false));
                return ()=> { window.removeEventListener('keydown',null); window.removeEventListener('keyup',null); };
            }, []);

            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => console.log(e));
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            };

            // Chat Gen
            useEffect(() => {
                if (gameState.showStream) {
                    const i = setInterval(() => {
                        if(Math.random()<0.1) setChat(p=>[...p, ...LOVER_CHATS[Math.floor(Math.random()*LOVER_CHATS.length)]]);
                        else if(Math.random()<0.6) setChat(p=>[...p, TENGLISH_CHATS[Math.floor(Math.random()*TENGLISH_CHATS.length)]]);
                        setChat(p=>p.slice(-15));
                    }, 2000);
                    return ()=>clearInterval(i);
                }
            }, [gameState.showStream]);

            // AI FETCH
            const fetchAI = async (prompt) => {
                if (!apiKey) return null;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers:{'Content-Type':'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const d = await res.json();
                    const txt = d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'');
                    return JSON.parse(txt);
                } catch(e) { return null; }
            };

            // BACKGROUND DELIVERY FETCH
            useEffect(() => {
                if (gameState.job) {
                    setDeliveryTip(null);
                    fetchAI("Generate 1 Math Shortcut for TS ECET. JSON: {\"topic\": \"Topic Name (English)\", \"tip\": \"Formula/Shortcut (English)\", \"msg\": \"Explanation in Tenglish\"}")
                    .then(res => {
                         if(res) setDeliveryTip(res);
                         else setDeliveryTip({topic:"Math Trick", tip:"a^2-b^2=(a+b)(a-b)", msg:"Basic formula bro!"});
                    });
                }
            }, [gameState.job]);

            const refillBuffer = async () => {
                if (fetchLock.current) return;
                fetchLock.current = true;
                const q = await fetchAI("Act as ECET Mentor. Generate 1 conceptual Math MCQ. STRICT JSON: {\"q\": \"Question in English only\", \"options\": [\"A\",\"B\",\"C\",\"D\"], \"correct\": 0, \"explanation\": \"Explanation in Tenglish only\", \"shortcut\": \"Shortcut in English\"}");
                if (q) setQBuffer(p => [...p, q]);
                fetchLock.current = false;
            };

            useEffect(() => { if (gameState.showStream && qBuffer.length < 3) refillBuffer(); }, [qBuffer, gameState.showStream]);

            const startStream = async () => {
                if (qBuffer.length > 0) {
                    setCurrentQ(qBuffer[0]); setQBuffer(p => p.slice(1));
                } else {
                    setLoading(true);
                    const q = await fetchAI("Act as ECET Mentor. Generate 1 conceptual Math MCQ. STRICT JSON: {\"q\": \"Question in English only\", \"options\": [\"A\",\"B\",\"C\",\"D\"], \"correct\": 0, \"explanation\": \"Explanation in Tenglish only\", \"shortcut\": \"Shortcut in English\"}");
                    setCurrentQ(q || {q:"Mock Q", options:["A","B","C","D"], correct:0, explanation:"Mock Exp", shortcut:"Mock Short"});
                    setLoading(false);
                }
                setExplanation(null);
                setChat(p=>[...p, {u:"System", t:"New Question!"}]);
            };

            const handleAns = (idx) => {
                if(idx == currentQ.correct) { setGameState(p=>({...p, subs:p.subs+20})); setChat(p=>[...p,{u:"System", t:"CORRECT!"}]); startStream(); }
                else { setGameState(p=>({...p, subs:Math.max(0,p.subs-10)})); setChat(p=>[...p,{u:"System", t:"Wrong! Check Explanation."}]); }
            };

            // MULTI TOUCH
            const handleJoy = (e) => {
                e.preventDefault();
                for (let i=0; i<e.changedTouches.length; i++) {
                    const t = e.changedTouches[i];
                    if (e.type === 'touchstart') {
                        joyTouchRef.current = { id: t.identifier, x: t.clientX, y: t.clientY };
                        if(joyRef.current) {
                            joyRef.current.style.display = 'block';
                            joyRef.current.style.left = t.clientX + 'px';
                            joyRef.current.style.top = t.clientY + 'px';
                        }
                    } else if (e.type === 'touchmove') {
                        if (joyTouchRef.current && t.identifier === joyTouchRef.current.id) {
                            const dx = t.clientX - joyTouchRef.current.x;
                            const dy = t.clientY - joyTouchRef.current.y;
                            controlsRef.current.moveX = Math.max(-1, Math.min(1, dx/50));
                            controlsRef.current.moveY = Math.max(-1, Math.min(1, -dy/50));
                        }
                    } else if (e.type === 'touchend' || e.type === 'touchcancel') {
                        if (joyTouchRef.current && t.identifier === joyTouchRef.current.id) {
                            joyTouchRef.current = null;
                            controlsRef.current.moveX = 0;
                            controlsRef.current.moveY = 0;
                            if(joyRef.current) joyRef.current.style.display = 'none';
                        }
                    }
                }
            };

            const handleLook = (e) => {
                e.preventDefault();
                for (let i=0; i<e.changedTouches.length; i++) {
                    const t = e.changedTouches[i];
                    if (e.type === 'touchstart') {
                        lookTouchRef.current = { id: t.identifier, x: t.clientX, y: t.clientY };
                    } else if (e.type === 'touchmove') {
                        if (lookTouchRef.current && t.identifier === lookTouchRef.current.id) {
                            const dx = t.clientX - lookTouchRef.current.x;
                            const dy = t.clientY - lookTouchRef.current.y;
                            controlsRef.current.lookX = dx * 0.11;
                            controlsRef.current.lookY = dy * 0.11;
                            lookTouchRef.current.x = t.clientX;
                            lookTouchRef.current.y = t.clientY;
                        }
                    } else if (e.type === 'touchend' || e.type === 'touchcancel') {
                        if (lookTouchRef.current && t.identifier === lookTouchRef.current.id) {
                            lookTouchRef.current = null;
                            controlsRef.current.lookX = 0;
                            controlsRef.current.lookY = 0;
                        }
                    }
                }
            };

            if (!started) return (
                <div className="absolute inset-0 bg-zinc-900 flex flex-col items-center justify-center text-white">
                    <h1 className="pixel-font text-4xl text-yellow-400 mb-8 text-center">STREAMER SIMULATOR<br/><span className="text-blue-400 text-2xl">MATH STREAMER GAME</span></h1>
                    <input className="bg-zinc-800 border border-zinc-600 p-4 rounded w-72 mb-4 text-center font-mono" placeholder="API KEY (Required For QUESTIONS)" value={apiKey} onChange={e=>setApiKey(e.target.value)} />
                    <button onClick={()=>setStarted(true)} className="pixel-font bg-green-600 px-8 py-4 rounded shadow-lg hover:bg-green-500">START GAME</button>
                </div>
            );

            return (
                <div className="w-full h-screen relative overflow-hidden">
                    <GameEngine controlsRef={controlsRef} onGameStateChange={handleGameUpdate} />
                    
                    <div className="absolute top-4 left-4 bg-black/70 p-3 rounded border border-white/20 text-white font-bold pixel-font text-xs z-20 pointer-events-none">
                        <div className="text-green-400 mb-1">â‚¹ {gameState.money} | V_1.0</div>
                        <div className="text-red-400">SUBS: {gameState.subs}</div>
                    </div>

                    <button onClick={toggleFullscreen} className="absolute top-4 right-4 bg-gray-800 text-white w-10 h-10 rounded border border-gray-600 font-bold z-30 flex items-center justify-center hover:bg-gray-700">F</button>

                    <div className="touch-layer">
                        <div className="touch-zone" 
                            onTouchStart={handleJoy} 
                            onTouchMove={handleJoy} 
                            onTouchEnd={handleJoy}
                            onTouchCancel={handleJoy}
                        ></div>
                        <div className="touch-zone" 
                            onTouchStart={handleLook} 
                            onTouchMove={handleLook} 
                            onTouchEnd={handleLook}
                            onTouchCancel={handleLook}
                        ></div>
                    </div>
                    <div ref={joyRef} className="joystick-base"><div className="joystick-stick"></div></div>

                    <div className="absolute bottom-24 right-8 z-30">
                        <button className={`w-24 h-24 rounded-full border-4 font-bold shadow-xl flex items-center justify-center text-sm ${gameState.actionText ? 'bg-yellow-500 text-black animate-pulse border-white' : 'bg-gray-800 text-gray-500 border-gray-600'}`}
                            onPointerDown={(e)=>{ e.preventDefault(); controlsRef.current.interact=true; }}>
                            {gameState.actionText || "USE"}
                        </button>
                    </div>

                    {gameState.msg && <div className="absolute top-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow-lg animate-bounce z-20 whitespace-nowrap">{gameState.msg}</div>}

                    {gameState.showTip && (
                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 p-4">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full text-center border-4 border-blue-500">
                                <h2 className="text-2xl font-bold text-blue-600 mb-2">JOB DONE! +â‚¹200</h2>
                                {deliveryTip ? (
                                    <div className="bg-yellow-100 p-4 rounded text-left">
                                        <div className="font-bold text-yellow-800 text-sm mb-1">SHORTCUT: {deliveryTip.topic}</div>
                                        <div className="text-lg font-bold mb-2"><MathText text={deliveryTip.tip} /></div>
                                        <div className="text-sm text-gray-600 italic"><MathText text={deliveryTip.msg} /></div>
                                    </div>
                                ) : <div className="text-gray-500 animate-pulse">Loading Trick...</div>}
                                <button onClick={()=>setGameState(p=>({...p, showTip:false}))} className="bg-green-600 text-white px-6 py-3 rounded font-bold w-full mt-4">OK</button>
                            </div>
                        </div>
                    )}

                    {gameState.showStream && (
                        <div className="absolute inset-0 z-50 bg-zinc-900 flex flex-col">
                            <div className="bg-purple-900 p-3 flex justify-between items-center text-white shadow-lg z-10">
                                <h2 className="pixel-font text-xs">24 HOURS LIVE!!!  |SUBSCRIBE|</h2>
                                <button onClick={()=>setGameState(p=>({...p, showStream:false}))} className="bg-red-600 px-3 py-1 rounded text-xs font-bold">EXIT</button>
                            </div>
                            <div className="flex-1 flex relative overflow-hidden">
                                <div className="w-1/3 max-w-xs bg-black/40 border-r border-white/10 p-3 flex flex-col justify-end overflow-hidden">
                                    <div className="space-y-2 chat-container">
                                        {chat.map((c,i) => <div key={i} className="text-xs text-white bg-black/20 p-1 rounded"><b className={c.u.includes('vedanth')?'text-pink-400':'text-blue-400'}>{c.u}:</b> {c.t}</div>)}
                                    </div>
                                </div>
                                <div className="flex-1 p-4 flex flex-col items-center justify-center bg-zinc-900 relative">
                                    {!currentQ && !loading && <button onClick={startStream} className="pixel-font bg-blue-600 text-white px-8 py-4 rounded shadow-lg">START</button>}
                                    {loading && <div className="text-green-400 pixel-font animate-pulse">LOADING...</div>}
                                    {currentQ && !explanation && (
                                        <div className="w-full max-w-lg bg-white rounded shadow-2xl overflow-hidden z-10">
                                            <div className="bg-gray-100 p-5 border-b text-center font-bold text-lg text-gray-800"><MathText text={currentQ.q} /></div>
                                            <div className="flex flex-col">
                                                {currentQ.options.map((o,i) => (
                                                    <button key={i} onClick={()=>handleAns(i)} className="p-4 text-left hover:bg-blue-50 border-b transition-colors font-medium text-gray-700">{String.fromCharCode(65+i)}. <MathText text={o} /></button>
                                                ))}
                                            </div>
                                            <button onClick={()=>setExplanation({ans:currentQ.options[currentQ.correct], text:currentQ.explanation, trick:currentQ.shortcut})} className="w-full bg-yellow-400 hover:bg-yellow-500 text-black font-bold py-3 border-t border-yellow-600">EXPLAIN PLEASE</button>
                                        </div>
                                    )}
                                    {explanation && (
                                        <div className="w-full max-w-lg bg-black border-4 border-yellow-500 rounded p-6 text-white z-20">
                                            <h3 className="text-yellow-400 font-bold text-xl mb-2">EXPLANATION : </h3>
                                            <div className="mb-4 text-sm text-gray-300"><MathText text={explanation.text} /></div>
                                            <div className="bg-blue-900/50 p-3 rounded border-l-4 border-blue-500 mb-4">
                                                <div className="text-blue-400 font-bold text-xs">SHORTCUT :</div>
                                                <div className="font-mono"><MathText text={explanation.trick} /></div>
                                            </div>
                                            <div className="text-green-400 font-bold mb-4">Correct: <MathText text={explanation.ans} /></div>
                                            <button onClick={startStream} className="w-full bg-green-600 text-white font-bold py-3 rounded">NEXT</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
